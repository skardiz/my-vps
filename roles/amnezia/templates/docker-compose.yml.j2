services:
  {{ amnezia_service_name }}:
    image: "{{ amnezia_image }}:{{ amnezia_image_tag }}"
    container_name: "{{ amnezia_container_name }}"
    restart: "{{ amnezia_restart_policy }}"

    deploy:
      resources:
        limits:
          memory: {{ amnezia_memory_limit }}

    environment:
      NGINX_PORT: "{{ amnezia_port_http }}"
      AUTO_START_SERVERS: "{{ amnezia_auto_start_servers }}"
      DEFAULT_MTU: "{{ amnezia_default_mtu }}"
      DEFAULT_SUBNET: "{{ amnezia_default_subnet }}"
      DEFAULT_PORT: "{{ amnezia_port_vpn }}"
      DEFAULT_DNS: "{{ amnezia_default_dns }}"
      # We use external auth (TinyAuth) via Caddy, so no BASIC_AUTH needed inside

    volumes:
      - "{{ amnezia_data_dir }}:/etc/amnezia"
      - "{{ amnezia_config_dir }}/nginx_default.conf:/etc/nginx/http.d/default.conf"

    ports:
      - "{{ amnezia_port_vpn }}:{{ amnezia_port_vpn }}/udp"

    # Required for VPN functionality
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

    networks:
      - {{ amnezia_docker_network }}

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:{{ amnezia_port_http }}/ || exit 1"]
      interval: {{ amnezia_hc_interval }}
      timeout: {{ amnezia_hc_timeout }}
      retries: {{ amnezia_hc_retries }}
      start_period: {{ amnezia_hc_start_period }}

    labels:
      # === CADDY CONFIGURATION ===
      caddy: "{{ amnezia_domain }}"
      caddy.import: "secure-headers"
      
      # Auth via TinyAuth (Forward Auth)
      # Important: 'handle' ensures auth is checked BEFORE proxying
      caddy.route: ""
      caddy.route.0_forward_auth: "tinyauth:3000"
      caddy.route.0_forward_auth.uri: "/api/auth/caddy"
      caddy.route.0_forward_auth.copy_headers: "Remote-User Remote-Name Remote-Email Remote-Groups"
      
      # Proxy to Amnezia UI
      caddy.route.1_reverse_proxy: "{{ amnezia_service_name }}:{{ amnezia_port_http }}"

networks:
  {{ amnezia_docker_network }}:
    external: true
