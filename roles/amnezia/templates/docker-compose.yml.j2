services:
  {{ amnezia_service_name }}:
    container_name: {{ amnezia_service_name }}
    image: {{ amnezia_image }}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

    environment:
      NGINX_PORT: "{{ amnezia_nginx_port }}"
      AUTO_START_SERVERS: "{{ amnezia_auto_start_servers }}"
      DEFAULT_MTU: "{{ amnezia_default_mtu }}"
      DEFAULT_SUBNET: "{{ amnezia_default_subnet }}"
      DEFAULT_PORT: "{{ amnezia_default_port }}"
      DEFAULT_DNS: "{{ amnezia_default_dns }}"

    volumes:
      - ./data:/etc/amnezia
      - ./config/nginx_default.conf:/etc/nginx/http.d/default.conf

    ports:
      - "{{ amnezia_wireguard_port }}:{{ amnezia_wireguard_port }}/udp"

    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    devices:
      - /dev/net/tun:/dev/net/tun

    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

    healthcheck:
      test:
        - "CMD-SHELL"
        - "curl -f http://127.0.0.1:{{ amnezia_nginx_port }}/ || exit 1"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    labels:
      caddy: "{{ amnezia_domain }}"
      caddy.import: "secure-headers"
      caddy.handle.0_forward_auth: "tinyauth:3000"
      caddy.handle.0_forward_auth.uri: "/api/auth/caddy"
      caddy.handle.0_forward_auth.copy_headers: "Remote-User Remote-Name Remote-Email Remote-Groups"
      caddy.handle.1_reverse_proxy: "{{ amnezia_service_name }}:{{ amnezia_nginx_port }}"    
    
    networks:
      - {{ docker_network_name }}

networks:
  {{ docker_network_name }}:
    external: true
