services:
  {{ amnezia.service }}:
    image: "{{ amnezia.image }}"
    container_name: "{{ amnezia.service }}"
    restart: "unless-stopped"

    deploy:
      resources:
        limits:
          memory: {{ amnezia.memory }}

    environment:
      NGINX_PORT: "{{ amnezia.ports.http }}"
      AUTO_START_SERVERS: "{{ amnezia.config.auto_start }}"
      DEFAULT_MTU: "{{ amnezia.config.mtu }}"
      DEFAULT_SUBNET: "{{ amnezia.config.subnet }}"
      DEFAULT_PORT: "{{ amnezia.ports.vpn }}"
      DEFAULT_DNS: "{{ amnezia.config.dns }}"

    volumes:
      - "{{ amnezia.path }}/data:/etc/amnezia"
      - "{{ amnezia.path }}/config/nginx_default.conf:/etc/nginx/http.d/default.conf"

    ports:
      - "{{ amnezia.ports.vpn }}:{{ amnezia.ports.vpn }}/udp"

    # VPN Requirements (Mandatory)
    cap_add: [NET_ADMIN, SYS_MODULE]
    devices: [/dev/net/tun:/dev/net/tun]
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

    networks:
      - {{ docker.network }}

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:{{ amnezia.ports.http }}/ || exit 1"]
      interval: {{ amnezia.healthcheck.interval }}
      timeout: {{ amnezia.healthcheck.timeout }}
      retries: {{ amnezia.healthcheck.retries }}
      start_period: {{ amnezia.healthcheck.start_period }}

    labels:
      # === INGRESS: CADDY ===
      caddy: "{{ amnezia.domain }}"
      caddy.import: "secure-headers"
      caddy.route: ""

      # Step 0: Auth (TinyAuth)
{% if amnezia.auth_enabled %}
      caddy.route.0_forward_auth: "tinyauth:3000"
      caddy.route.0_forward_auth.uri: "/api/auth/caddy"
      caddy.route.0_forward_auth.copy_headers: "Remote-User Remote-Name Remote-Email Remote-Groups"
{% endif %}

      # Step 9: Proxy
      caddy.route.9_reverse_proxy: "{{ amnezia.service }}:{{ amnezia.ports.http }}"

      # === AUTOHEAL ===
{% if amnezia.autoheal | bool %}
      autoheal: "true"
{% endif %}

networks:
  {{ docker.network }}:
    external: true
