{% import playbook_dir ~ '/roles/utils/templates/traefik_macros.j2' as traefik %}

services:
  {{ amnezia_service_name }}:
    container_name: {{ amnezia_service_name }}
    image: {{ amnezia_image }}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
    
    environment:
      NGINX_PORT: "{{ amnezia_nginx_port }}"
      AUTO_START_SERVERS: "{{ amnezia_auto_start_servers }}"
      DEFAULT_MTU: "{{ amnezia_default_mtu }}"
      DEFAULT_SUBNET: "{{ amnezia_default_subnet }}"
      DEFAULT_PORT: "{{ amnezia_default_port }}"
      DEFAULT_DNS: "{{ amnezia_default_dns }}"

    volumes:
      - ./data:/etc/amnezia
      - ./config/nginx_default.conf:/etc/nginx/http.d/default.conf

    ports:
      - "{{ amnezia_wireguard_port }}:{{ amnezia_wireguard_port }}/udp"

    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    devices:
      - /dev/net/tun:/dev/net/tun

    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

    healthcheck:
      test:
        - "CMD-SHELL"
        - "curl -f http://127.0.0.1:{{ amnezia_nginx_port }}/ || exit 1"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    labels:
{{ traefik.web(
     service=amnezia_service_name,
     host=amnezia_domain,
     port=amnezia_nginx_port,
     middlewares="geoblock-strict@file,tinyauth@docker"
   ) | indent(6) }}

    networks:
      - {{ docker_network_name }}

networks:
  {{ docker_network_name }}:
    external: true
