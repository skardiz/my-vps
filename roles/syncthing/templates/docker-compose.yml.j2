services:
  {{ syncthing.service }}:
    image: "{{ syncthing.image }}"
    container_name: "{{ syncthing.service }}"
    restart: "unless-stopped"
    # DISABLE DOCKER INIT (Conflict with s6-overlay in LinuxServer images)
    init: false

    deploy:
      resources:
        limits:
          memory: {{ syncthing.memory }}

    environment:
      PUID: "{{ syncthing.puid }}"
      PGID: "{{ syncthing.pgid }}"
      TZ: "{{ system.timezone | default('UTC') }}"

    volumes:
      - "./config:/config"
      - "{{ syncthing.data_dir }}:/data"

    ports:
      - "{{ syncthing.ports.tcp }}:{{ syncthing.ports.tcp }}/tcp"
      - "{{ syncthing.ports.udp }}:{{ syncthing.ports.udp }}/udp"
      - "{{ syncthing.ports.discovery }}:{{ syncthing.ports.discovery }}/udp"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8384/rest/noauth/health"]
      interval: {{ syncthing.healthcheck.interval }}
      timeout: {{ syncthing.healthcheck.timeout }}
      retries: {{ syncthing.healthcheck.retries }}
      start_period: {{ syncthing.healthcheck.start_period }}

    labels:
      # === INGRESS: CADDY ===
      caddy: "{{ syncthing.domain }}"
      caddy.import: "secure-headers"
      caddy.route: ""

{% if syncthing.auth_enabled %}
      caddy.route.0_forward_auth: "tinyauth:3000"
      caddy.route.0_forward_auth.uri: "/api/auth/caddy"
      caddy.route.0_forward_auth.copy_headers: "Remote-User Remote-Name Remote-Email Remote-Groups"
{% endif %}

      caddy.route.9_reverse_proxy: "{{ syncthing.service }}:{{ syncthing.ports.web }}"

      # === AUTOHEAL ===
{% if syncthing.autoheal | bool %}
      autoheal: "true"
{% endif %}

    networks:
      - {{ docker.network }}

networks:
  {{ docker.network }}:
    external: true
