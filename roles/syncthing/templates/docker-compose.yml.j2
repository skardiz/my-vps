{% import 'traefik_macros.j2' as traefik %}

services:
  {{ syncthing_service_name }}:
    container_name: {{ syncthing_service_name }}
    image: {{ syncthing_image }}
    restart: unless-stopped

    deploy:
      resources:
        limits:
          memory: 384M

    environment:
      PUID: "{{ syncthing_puid }}"
      PGID: "{{ syncthing_pgid }}"
      TZ: "{{ syncthing_tz }}"

    volumes:
      - "./config:/config"
      - "./data:/data"

    ports:
      - "{{ syncthing_tcp_port }}:{{ syncthing_tcp_port }}/tcp"
      - "{{ syncthing_udp_port }}:{{ syncthing_udp_port }}/udp"
      - "{{ syncthing_discovery_port }}:{{ syncthing_discovery_port }}/udp"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8384/rest/noauth/health"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 1m

    labels:
{{ traefik.web(
     service=syncthing_service_name,
     host=syncthing_domain,
     port=syncthing_web_port,
     network=docker_network_name,
     middlewares="geoblock-strict@file,tinyauth@docker"
   ) | indent(6, first=True) }}

    networks:
      - {{ docker_network_name }}

networks:
  {{ docker_network_name }}:
    external: true
