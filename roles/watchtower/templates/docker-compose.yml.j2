services:
  {{ watchtower.service }}:
    image: "{{ watchtower.image }}"
    container_name: "{{ watchtower.service }}"
    restart: "unless-stopped"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      # - /home/{{ deploy_user }}/.docker/config.json:/config.json

    environment:
      # --- Scheduling ---
      - WATCHTOWER_SCHEDULE={{ watchtower.config.schedule }}

      # --- Behavior ---
      - WATCHTOWER_CLEANUP={{ watchtower.config.cleanup | lower }}
      - WATCHTOWER_INCLUDE_STOPPED={{ watchtower.config.include_stopped | lower }}
      - WATCHTOWER_REVIVE_STOPPED={{ watchtower.config.revive_stopped | lower }}
      - WATCHTOWER_MONITOR_ONLY={{ watchtower.config.monitor_only | lower }}

      # --- Safety ---
      - WATCHTOWER_ROLLING_RESTART={{ watchtower.config.rolling_restart | lower }}
      - WATCHTOWER_TIMEOUT={{ watchtower.config.timeout }}

      # --- Notifications ---
{% if watchtower.notification_url | length > 0 %}
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL={{ watchtower.notification_url }}
      - WATCHTOWER_NO_STARTUP_MESSAGE={{ watchtower.config.no_startup_message | lower }}
{% endif %}

    deploy:
      resources:
        limits:
          memory: {{ watchtower.memory }}

    networks:
      - {{ docker.network }}

networks:
  {{ docker.network }}:
    external: true
