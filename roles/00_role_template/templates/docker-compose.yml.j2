services:
  {{ template_service_name }}:
    image: "{{ template_image_name }}:{{ template_version }}"
    container_name: "{{ template_container_name }}"
    restart: "{{ template_restart_policy }}"

    deploy:
      resources:
        limits:
          memory: {{ template_memory_limit }}

    ports:
      - "{{ template_port_example }}:80"

    environment:
      ACME_EMAIL: "{{ template_acme_email }}"
      TZ: "{{ template_timezone }}"
      # PUID: "{{ template_puid | default('') }}"
      # PGID: "{{ template_pgid | default('') }}"

    volumes:
      - "{{ template_data_dir }}:/data"
      - "{{ template_config_dir }}:/config"

    networks:
      - {{ template_docker_network }}

{% if template_hc_enabled %}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80/health"]
      interval: {{ template_hc_interval }}
      timeout: {{ template_hc_timeout }}
      retries: {{ template_hc_retries }}
      start_period: {{ template_hc_start_period }}
{% endif %}

    labels:
      # === CADDY CONFIGURATION ===
      # 1. Basic Proxy (Domain + HTTPS)
      caddy: "{{ template_service_name }}.{{ base_domain }}"
      caddy.reverse_proxy: "{{ template_container_name }}:80"
      caddy.import: "secure-headers"
      
      # 2. Autoheal (Restart if unhealthy)
      # autoheal: "true"

      # 3. Authentication (Protect this service)
      # -- Option A: Basic Auth (Login/Password) --
      # caddy.basicauth: "/*"
      # caddy.basicauth.admin: "JDJhJDE0..." # Hash generated via `caddy hash-password`

      # -- Option B: Forward Auth (Single Sign-On via TinyAuth/Authelia) --
      # caddy.forward_auth: "{{ template_service_name }}:80"
      # caddy.forward_auth.uri: "/api/auth/verify"
      # caddy.forward_auth.copy_headers: "X-User X-Email"

networks:
  {{ template_docker_network }}:
    external: true
