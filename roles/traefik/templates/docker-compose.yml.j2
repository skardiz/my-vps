services:
  {{ traefik_service_name }}:
    container_name: {{ traefik_service_name }}
    image: {{ traefik_image }}
    
    # –ú—ã –ø–µ—Ä–µ–Ω–µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥ –≤ —Ñ–∞–π–ª, –ø–æ—ç—Ç–æ–º—É —Ç—É—Ç –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø–ª–∞–≥–∏–Ω—ã
    command:
      - "--experimental.plugins.geoblock.settings.useunsafe=true"
      # –ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É, —Ç–∞–∫ –∫–∞–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é traefik –∏—â–µ—Ç traefik.yml, –Ω–æ –º—ã –º–∞—É–Ω—Ç–∏–º —è–≤–Ω–æ
      - "--configFile=/etc/traefik/traefik.yml"

    ports:
      - "{{ traefik_http_port }}:{{ traefik_http_port }}"
      - "{{ traefik_https_port }}:{{ traefik_https_port }}"

    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "{{ traefik_data_dir }}/acme.json:{{ traefik_acme_storage }}"
      # –ù–æ–≤—ã–µ –º–∞—É–Ω—Ç—ã:
      - "{{ traefik_data_dir }}/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "{{ traefik_data_dir }}/dynamic_conf.yml:/etc/traefik/dynamic_conf.yml:ro"
      - "traefik_geodb:/data/ip2database"

    restart: unless-stopped

    labels:
      traefik.enable: "true"
      
      # –°–µ—Ä–≤–∏—Å API
      traefik.http.services.{{ traefik_service_name }}.loadbalancer.server.port: "8080"

      # –î–∞—à–±–æ—Ä–¥
      traefik.http.routers.dashboard.rule: "Host(`{{ traefik_dashboard_domain }}`)"
      traefik.http.routers.dashboard.service: "api@internal"
      traefik.http.routers.dashboard.entrypoints: "websecure"
      traefik.http.routers.dashboard.tls: "true"
      traefik.http.routers.dashboard.tls.certresolver: "letsencrypt"

      # üî• –¶–ï–ü–û–ß–ö–ê –ó–ê–©–ò–¢–´ –î–ê–®–ë–û–†–î–ê: –°–Ω–∞—á–∞–ª–∞ –ì–ï–û–ë–õ–û–ö, –ø–æ—Ç–æ–º –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø üî•
      # geoblock-strict@file - —Ç–æ–ª—å–∫–æ RU/NL
      # tinyauth@docker - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
      traefik.http.routers.dashboard.middlewares: "geoblock-strict@file,tinyauth@docker"

      traefik.docker.network: "{{ traefik_docker_network }}"

    networks:
      - {{ traefik_docker_network }}

volumes:
  traefik_geodb:

networks:
  {{ traefik_docker_network }}:
    external: true
