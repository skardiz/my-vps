services:
  {{ pocketid_service_name }}:
    container_name: {{ pocketid_service_name }}
    image: {{ pocketid_image }}
    restart: unless-stopped

    environment:
      APP_URL: "https://{{ pocketid_domain }}"
      TRUST_PROXY: "{{ pocketid_trust_proxy }}"
      PUID: "{{ pocketid_puid }}"
      PGID: "{{ pocketid_pgid }}"
{% if pocketid_maxmind_license_key %}
      MAXMIND_LICENSE_KEY: "{{ pocketid_maxmind_license_key }}"
{% endif %}

    volumes:
      - "{{ pocketid_data_dir }}/data:/app/data"

    healthcheck:
      test: ["CMD", "/app/pocket-id", "healthcheck"]
      interval: 1m30s
      timeout: 5s
      retries: 2
      start_period: 10s

    labels:
      traefik.enable: "true"
      traefik.docker.network: "{{ docker_network_name }}"

      # HTTP —Ä–æ—É—Ç–µ—Ä
      traefik.http.routers.{{ pocketid_service_name }}-http.rule: "Host(`{{ pocketid_domain }}`)"
      traefik.http.routers.{{ pocketid_service_name }}-http.entrypoints: "web"
      traefik.http.routers.{{ pocketid_service_name }}-http.service: "{{ pocketid_service_name }}"

      # HTTPS —Ä–æ—É—Ç–µ—Ä
      traefik.http.routers.{{ pocketid_service_name }}.rule: "Host(`{{ pocketid_domain }}`)"
      traefik.http.routers.{{ pocketid_service_name }}.entrypoints: "websecure"
      traefik.http.routers.{{ pocketid_service_name }}.tls: "true"
      traefik.http.routers.{{ pocketid_service_name }}.tls.certresolver: "letsencrypt"
      traefik.http.routers.{{ pocketid_service_name }}.service: "{{ pocketid_service_name }}"

      # üîí –ó–ê–©–ò–¢–ê: –¢–û–õ–¨–ö–û GEOBLOCK üîí (–ü–∞—Ä–æ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∞–º PocketID)
      traefik.http.routers.{{ pocketid_service_name }}.middlewares: "geoblock-strict@file"

      # –°–µ—Ä–≤–∏—Å (PocketID —Å–ª—É—à–∞–µ—Ç –Ω–∞ 1411!)
      traefik.http.services.{{ pocketid_service_name }}.loadbalancer.server.port: "1411"

    networks:
      - {{ docker_network_name }}

networks:
  {{ docker_network_name }}:
    external: true
