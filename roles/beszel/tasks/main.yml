---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - beszel.domain is defined
      - beszel.admin.email is defined
      - deploy_user is defined
    fail_msg: "CRITICAL: Required variables missing for Beszel"
  tags: [beszel, check]

- name: Ensure Docker network exists
  community.docker.docker_network:
    name: "{{ docker.network }}"
    state: present
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, network]

- name: Ensure Beszel directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - "{{ beszel.path }}"
    - "{{ beszel.data_dir }}"
  tags: [beszel, deploy]

# ==============================================================================
# ðŸ¤– SECRET MANAGEMENT (Hub-driven)
# ==============================================================================

- name: Check for existing secrets file
  ansible.builtin.stat:
    path: "{{ beszel.path }}/.beszel_secrets"
  register: beszel_secrets_file
  tags: [beszel, config]

- name: Read existing secrets
  ansible.builtin.slurp:
    src: "{{ beszel.path }}/.beszel_secrets"
  register: beszel_secrets_content
  when: beszel_secrets_file.stat.exists
  tags: [beszel, config]

# BOOTSTRAP: Start Hub only
- name: Render Bootstrap docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel.path }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    beszel_dynamic_key: "bootstrap_waiting"
    beszel_dynamic_token: "bootstrap_waiting"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, deploy]

- name: Deploy Beszel Hub (Bootstrap)
  community.docker.docker_compose_v2:
    project_src: "{{ beszel.path }}"
    state: present
    pull: missing
    services: ["hub"]
  become: true
  become_user: "{{ deploy_user }}"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, deploy]

- name: Wait for Beszel Hub API
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ beszel.hub.port }}/health"
    status_code: 200
  register: beszel_api_check
  until: beszel_api_check.status == 200
  retries: 20
  delay: 3
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, config]

- name: "âš¡ AUTO-CONFIG: Fetch Beszel Secrets"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      # Login Admin
      ADM_TOK=$(curl -s -X POST "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel.admin.email }}","password":"{{ beszel.admin.password }}"}' | jq -r '.token')

      # Get Pub Key
      KEY_RESP=$(curl -s "http://127.0.0.1:{{ beszel.hub.port }}/api/beszel/getkey" -H "Authorization: $ADM_TOK")
      PUB_KEY=$(echo "$KEY_RESP" | jq -r '.key // empty')

      # Login User
      USER_TOK=$(curl -s -X POST "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/users/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel.admin.email }}","password":"{{ beszel.admin.password }}"}' | jq -r '.token')

      if [ -z "$USER_TOK" ] || [ "$USER_TOK" == "null" ]; then USER_TOK=$ADM_TOK; fi

      # Get Token
      TOK_RESP=$(curl -s "http://127.0.0.1:{{ beszel.hub.port }}/api/beszel/universal-token?enable=1" -H "Authorization: $USER_TOK")
      UNIV_TOKEN=$(echo "$TOK_RESP" | jq -r '.token // empty')

      echo "KEY:$PUB_KEY"
      echo "TOKEN:$UNIV_TOKEN"
    executable: /bin/bash
  register: beszel_secrets_new
  when: not beszel_secrets_file.stat.exists
  changed_when: false
  tags: [beszel, config]

- name: Save Beszel Secrets to file
  ansible.builtin.copy:
    content: |
      BESZEL_PUB_KEY={{ beszel_secrets_new.stdout | regex_search('KEY:(ssh-ed25519 [^\s]+)', '\1') | first }}
      BESZEL_AGENT_TOKEN={{ beszel_secrets_new.stdout | regex_search('TOKEN:([a-f0-9-]+)', '\1') | first }}
    dest: "{{ beszel.path }}/.beszel_secrets"
    mode: "0600"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, config]

- name: Set Beszel Final Facts
  ansible.builtin.set_fact:
    beszel_final_key: >-
      {{ (beszel_secrets_content['content'] | b64decode | regex_search('BESZEL_PUB_KEY=([^\n]+)', '\1') | first)
      if beszel_secrets_file.stat.exists
      else (beszel_secrets_new.stdout | regex_search('KEY:(ssh-ed25519 [^\s]+)', '\1') | first) }}
    beszel_final_token: >-
      {{ (beszel_secrets_content['content'] | b64decode | regex_search('BESZEL_AGENT_TOKEN=([^\n]+)', '\1') | first)
      if beszel_secrets_file.stat.exists
      else (beszel_secrets_new.stdout | regex_search('TOKEN:([a-f0-9-]+)', '\1') | first) }}
  tags: [beszel, config]

# ==============================================================================
# ðŸ¤– OIDC SETUP
# ==============================================================================

- name: Check for existing OIDC secrets file
  ansible.builtin.stat:
    path: "{{ beszel.path }}/.beszel_oidc_secrets"
  register: beszel_oidc_file
  tags: [beszel, config, oidc]

- name: Read existing OIDC secrets
  ansible.builtin.slurp:
    src: "{{ beszel.path }}/.beszel_oidc_secrets"
  register: beszel_oidc_content
  when: beszel_oidc_file.stat.exists
  tags: [beszel, config, oidc]

# 1. ÐÐ²Ñ‚Ð¾-Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð² PocketID Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð² Ñ„Ð°Ð¹Ð»
- name: "âš¡ AUTO-SETUP: OIDC Client for Beszel"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      rm -f /tmp/pocket_cookie_beszel.txt

      # Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ, Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼ (Ð½Ð¾ Ð»ÑƒÑ‡ÑˆÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· when Ð² ansible)
      if [ -f "{{ beszel.path }}/.beszel_oidc_secrets" ]; then
        echo "SKIPPED"
        exit 0
      fi

      sleep 2

      # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð°Ð´Ð¼Ð¸Ð½Ð°
      LINK=$(docker exec pocketid /app/pocket-id one-time-access-token {{ beszel.oidc.admin_dn }})
      TOKEN=$(echo "$LINK" | grep -o 'https://[^ ]*' | awk -F/ '{print $NF}' | tr -d '\r')

      # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ
      curl -s -c /tmp/pocket_cookie_beszel.txt -X POST "http://127.0.0.1:1411/api/one-time-access-token/$TOKEN" > /dev/null

      # 1. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð‘Ð•Ð— PKCE, Ñ‚.Ðº. Ñ Ð½Ð¸Ð¼ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð¼)
      RESP=$(curl -s -b /tmp/pocket_cookie_beszel.txt \
        -X POST "http://127.0.0.1:1411/api/oidc/clients" \
        -H "Content-Type: application/json" \
        -d '{
          "name": "Beszel",
          "launchUrl": "https://{{ beszel.domain }}",
          "callbackUrls": ["https://{{ beszel.domain }}/api/oauth2-redirect"],
          "pkceEnabled": true,
          "isPublic": false
        }')

      # ÐŸÐ°Ñ€ÑÐ¸Ð¼ ID
      CLIENT_ID=$(echo "$RESP" | jq -r '.id // empty')

      if [ -z "$CLIENT_ID" ]; then
        echo "FAIL: No ID created. Resp: $RESP"
        exit 1
      fi

      # 2. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚ (ÐžÐ¢Ð”Ð•Ð›Ð¬ÐÐ«Ðœ Ð—ÐÐŸÐ ÐžÐ¡ÐžÐœ!)
      SECRET_RESP=$(curl -s -b /tmp/pocket_cookie_beszel.txt -X POST "http://127.0.0.1:1411/api/oidc/clients/$CLIENT_ID/secret")
      CLIENT_SECRET=$(echo "$SECRET_RESP" | jq -r '.secret // empty')

      if [ -z "$CLIENT_SECRET" ]; then
        echo "FAIL: No Secret generated. Resp: $SECRET_RESP"
        exit 1
      fi

      # ÐŸÐ¸ÑˆÐµÐ¼ Ð² Ñ„Ð°Ð¹Ð»
      echo "ID:$CLIENT_ID"
      echo "SECRET:$CLIENT_SECRET"
    executable: /bin/bash
  register: beszel_auto_oidc
  when:
    - not beszel_oidc_file.stat.exists
    - beszel.oidc.enabled | bool
  changed_when: true
  tags: [beszel, config, oidc]

# 2. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð² Ñ„Ð°Ð¹Ð» (Ð±ÐµÑ€ÐµÐ¼ Ð¸Ð· stdout shell-ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹)
- name: Save Beszel OIDC secrets
  ansible.builtin.copy:
    content: |
      CLIENT_ID={{ beszel_auto_oidc.stdout | regex_search('ID:([^\s]+)', '\1') | first }}
      CLIENT_SECRET={{ beszel_auto_oidc.stdout | regex_search('SECRET:([^\s]+)', '\1') | first }}
    dest: "{{ beszel.path }}/.beszel_oidc_secrets"
    mode: "0600"
    owner: "{{ deploy_user }}"
  when:
    - not beszel_oidc_file.stat.exists
    - beszel_auto_oidc.changed
    - "'ID:' in beszel_auto_oidc.stdout"
  tags: [beszel, config, oidc]

# 3. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð°ÐºÑ‚Ñ‹ (Final Facts)
- name: Set Beszel OIDC Facts
  ansible.builtin.set_fact:
    beszel_final_client_id: >-
      {{ (beszel_oidc_content['content'] | b64decode | regex_search('CLIENT_ID=([^\n]+)', '\1') | first)
      if beszel_oidc_file.stat.exists
      else (beszel_auto_oidc.stdout | regex_search('ID:([^\s]+)', '\1') | first | default('')) }}
    beszel_final_client_secret: >-
      {{ (beszel_oidc_content['content'] | b64decode | regex_search('CLIENT_SECRET=([^\n]+)', '\1') | first)
      if beszel_oidc_file.stat.exists
      else (beszel_auto_oidc.stdout | regex_search('SECRET:([^\s]+)', '\1') | first | default('')) }}
  tags: [beszel, config, oidc]

# ==============================================================================
# ðŸš€ FINAL DEPLOYMENT
# ==============================================================================

- name: Render docker-compose.yml (Final)
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel.path }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    beszel_dynamic_key: "{{ beszel_final_key }}"
    beszel_dynamic_token: "{{ beszel_final_token }}"
  tags: [beszel, deploy]

- name: Deploy Beszel Stack (Full)
  community.docker.docker_compose_v2:
    project_src: "{{ beszel.path }}"
    state: present
    pull: missing
    remove_orphans: true
    recreate: auto
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, deploy]

- name: "âš¡ AUTO-CONFIG: Patch Beszel OIDC Settings"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      TOKEN=$(curl -s -X POST "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel.admin.email }}","password":"{{ beszel.admin.password }}"}' | jq -r '.token')

      if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then echo "FAIL: Login"; exit 1; fi

      curl -X PATCH "http://127.0.0.1:{{ beszel.hub.port }}/api/collections/users" \
        -H "Authorization: $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
          \"oauth2\": {
            \"enabled\": true,
            \"providers\": [
              {
                \"name\": \"oidc\",
                \"title\": \"PocketID\",
                \"clientId\": \"{{ beszel_final_client_id }}\",
                \"clientSecret\": \"{{ beszel_final_client_secret }}\",
                \"authUrl\": \"https://{{ beszel.oidc.identity_domain }}/authorize\",
                \"tokenUrl\": \"https://{{ beszel.oidc.identity_domain }}/api/oidc/token\",
                \"userInfoUrl\": \"https://{{ beszel.oidc.identity_domain }}/api/oidc/userinfo\",
                \"displayName\": \"PocketID\",
                \"pkce\": true
              }
            ]
          }
        }"
    executable: /bin/bash
  when:
    - beszel.admin.email | length > 0
    - beszel_final_client_id | length > 0
    - beszel_final_client_secret | length > 0
  register: beszel_patch_result
  changed_when: false
  tags: [beszel, config, oidc]
