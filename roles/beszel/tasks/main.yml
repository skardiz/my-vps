---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - beszel_domain is defined
      - beszel_admin_email is defined
      - deploy_user is defined
    fail_msg: "CRITICAL: Required variables missing for Beszel"
  tags: [beszel, check]

- name: Ensure Docker network exists
  community.docker.docker_network:
    name: "{{ beszel_network }}"
    state: present
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, network]

# 1. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿Ð¾Ðº
- name: Ensure Beszel directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - "{{ beszel_root }}"
    - "{{ beszel_hub_data }}"
  tags: [beszel, deploy]

# ==============================================================================
# ðŸ¤– SECRET MANAGEMENT (Hub-driven)
# ==============================================================================

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹
- name: Check for existing secrets file
  ansible.builtin.stat:
    path: "{{ beszel_root }}/.beszel_secrets"
  register: beszel_secrets_file
  tags: [beszel, config]

# 2. Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» ÐµÑÑ‚ÑŒ â€” Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼
- name: Read existing secrets
  ansible.builtin.slurp:
    src: "{{ beszel_root }}/.beszel_secrets"
  register: beszel_secrets_content
  when: beszel_secrets_file.stat.exists
  tags: [beszel, config]

# 3. BOOTSTRAP: Ð•ÑÐ»Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð½ÐµÑ‚, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Hub, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½ Ð¸Ñ… Ñ€Ð¾Ð´Ð¸Ð»
- name: Render Bootstrap docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel_root }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Hub Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ. ÐÐ³ÐµÐ½Ñ‚ Ð¿Ð¾ÐºÐ° ÑƒÐ¿Ð°Ð´ÐµÑ‚/Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑÑ.
    beszel_dynamic_key: "bootstrap_waiting"
    beszel_dynamic_token: "bootstrap_waiting"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, deploy]

- name: Deploy Beszel Hub (Bootstrap)
  community.docker.docker_compose_v2:
    project_src: "{{ beszel_root }}"
    state: present
    pull: missing
    services: ["hub"] # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž Hub
  become: true
  become_user: "{{ deploy_user }}"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, deploy]

- name: Wait for Beszel Hub API
  ansible.builtin.uri:
    url: "http://127.0.0.1:8090/health"
    status_code: 200
  register: beszel_api_check
  until: beszel_api_check.status == 200
  retries: 20
  delay: 3
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, config]

# 4. Ð—Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ»ÑŽÑ‡Ð¸ Ñƒ Hub'Ð° (Local API)
- name: "âš¡ AUTO-CONFIG: Fetch Beszel Secrets"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      # Login Admin (Localhost!)
      ADM_TOK=$(curl -s -X POST "http://127.0.0.1:8090/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel_admin_email }}","password":"{{ beszel_admin_password }}"}' | jq -r '.token')

      # Get Pub Key (Localhost!)
      KEY_RESP=$(curl -s "http://127.0.0.1:8090/api/beszel/getkey" -H "Authorization: $ADM_TOK")
      PUB_KEY=$(echo "$KEY_RESP" | jq -r '.key // empty')

      # Login User (Localhost!)
      USER_TOK=$(curl -s -X POST "http://127.0.0.1:8090/api/collections/users/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel_admin_email }}","password":"{{ beszel_admin_password }}"}' | jq -r '.token')

      if [ -z "$USER_TOK" ] || [ "$USER_TOK" == "null" ]; then USER_TOK=$ADM_TOK; fi

      # Get Token (Localhost!)
      TOK_RESP=$(curl -s "http://127.0.0.1:8090/api/beszel/universal-token?enable=1" -H "Authorization: $USER_TOK")
      UNIV_TOKEN=$(echo "$TOK_RESP" | jq -r '.token // empty')

      echo "KEY:$PUB_KEY"
      echo "TOKEN:$UNIV_TOKEN"
    executable: /bin/bash
  register: beszel_secrets_new
  when: not beszel_secrets_file.stat.exists
  changed_when: false # Ð­Ñ‚Ð¾ Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ, Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ
  tags: [beszel, config]

# 5. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡Ð¸ Ð² Ñ„Ð°Ð¹Ð» (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð´ÐµÑ€Ð³Ð°Ñ‚ÑŒ API ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ€Ð°Ð·)
- name: Save Beszel Secrets to file
  ansible.builtin.copy:
    content: |
      BESZEL_PUB_KEY={{ beszel_secrets_new.stdout | regex_search('KEY:(ssh-ed25519 [^\s]+)', '\1') | first }}
      BESZEL_AGENT_TOKEN={{ beszel_secrets_new.stdout | regex_search('TOKEN:([a-f0-9-]+)', '\1') | first }}
    dest: "{{ beszel_root }}/.beszel_secrets"
    mode: "0600"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  when: not beszel_secrets_file.stat.exists
  tags: [beszel, config]

# 6. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ„Ð°ÐºÑ‚Ñ‹
- name: Set Beszel Final Facts
  ansible.builtin.set_fact:
    beszel_final_key: >-
      {{ (beszel_secrets_content['content'] | b64decode | regex_search('BESZEL_PUB_KEY=([^\n]+)', '\1') | first)
      if beszel_secrets_file.stat.exists
      else (beszel_secrets_new.stdout | regex_search('KEY:(ssh-ed25519 [^\s]+)', '\1') | first) }}
    beszel_final_token: >-
      {{ (beszel_secrets_content['content'] | b64decode | regex_search('BESZEL_AGENT_TOKEN=([^\n]+)', '\1') | first)
      if beszel_secrets_file.stat.exists
      else (beszel_secrets_new.stdout | regex_search('TOKEN:([a-f0-9-]+)', '\1') | first) }}
  tags: [beszel, config]

# ==============================================================================
# ðŸ¤– OIDC SETUP
# ==============================================================================

- name: Check for existing OIDC secrets file
  ansible.builtin.stat:
    path: "{{ beszel_root }}/.beszel_oidc_secrets"
  register: beszel_oidc_file
  tags: [beszel, config, oidc]

- name: Read existing OIDC secrets
  ansible.builtin.slurp:
    src: "{{ beszel_root }}/.beszel_oidc_secrets"
  register: beszel_oidc_content
  when: beszel_oidc_file.stat.exists
  tags: [beszel, config, oidc]

- name: Generate PocketID Token (if needed)
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      # Ð˜Ñ‰ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð±ÐµÐ· Jinja-ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²
      if [ -z "$(docker ps -q -f 'name=^pocketid$')" ]; then
        echo ""
        exit 0
      fi

      RAW_OUTPUT=$(docker exec pocketid /app/pocket-id one-time-access-token {{ beszel_lldap_admin_dn }} 2>&1)
      TOKEN=$(printf '%s\n' "$RAW_OUTPUT" | grep -oE 'lc/[a-zA-Z0-9]+' | head -n1 | cut -d/ -f2)
      echo "$TOKEN"
    executable: /bin/bash
  register: beszel_pocketid_token_gen
  when:
    - (beszel_client_id | default('') | length == 0)
    - not beszel_oidc_file.stat.exists
  changed_when: false
  tags: [beszel, config, oidc]

- name: "âš¡ AUTO-CONFIG: Create Beszel Client in PocketID"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      TOKEN="{{ beszel_pocketid_token_gen.stdout | trim }}"
      if [ -z "$TOKEN" ]; then echo "SKIP"; exit 0; fi

      rm -f /tmp/beszel_pocket_cookie.txt
      # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð´Ñ€ÐµÑ PocketID
      curl -s -c /tmp/beszel_pocket_cookie.txt -X POST "http://127.0.0.1:1411/api/one-time-access-token/$TOKEN" > /dev/null

      RESP=$(curl -s -b /tmp/beszel_pocket_cookie.txt \
        -X POST "http://127.0.0.1:1411/api/oidc/clients" \
        -H "Content-Type: application/json" \
        -d '{
          "name": "Beszel Monitor",
          "launchUrl": "https://{{ beszel_domain }}",
          "callbackUrls": ["https://{{ beszel_domain }}/api/oauth2-redirect"],
          "pkceEnabled": true,
          "isPublic": false
        }')
      ID=$(echo "$RESP" | jq -r '.id // empty')
      SECRET=$(echo "$RESP" | jq -r '.credentials.secret // .clientSecret // empty')

      if [ -n "$ID" ] && [ -z "$SECRET" ]; then
          S_RESP=$(curl -s -b /tmp/beszel_pocket_cookie.txt \
            -X POST "http://127.0.0.1:1411/api/oidc/clients/$ID/secret" \
            -H "Content-Type: application/json")
          SECRET=$(echo "$S_RESP" | jq -r '.secret // empty')
      fi

      if [ -n "$ID" ] && [ -n "$SECRET" ]; then
         echo "BZ_ID:$ID"
         echo "BZ_SECRET:$SECRET"
      fi
      rm -f /tmp/beszel_pocket_cookie.txt
    executable: /bin/bash
  when:
    - (beszel_client_id | default('') | length == 0)
    - not beszel_oidc_file.stat.exists
    - beszel_pocketid_token_gen.stdout | length > 0
  register: beszel_oidc_new
  changed_when: "'BZ_ID:' in beszel_oidc_new.stdout"
  tags: [beszel, config, oidc]

- name: Save OIDC secrets to file
  ansible.builtin.copy:
    content: |
      BESZEL_OIDC_CLIENT_ID={{ beszel_oidc_new.stdout | regex_search('BZ_ID:([a-zA-Z0-9-]+)', '\1') | first }}
      BESZEL_OIDC_CLIENT_SECRET={{ beszel_oidc_new.stdout | regex_search('BZ_SECRET:([a-zA-Z0-9-]+)', '\1') | first }}
    dest: "{{ beszel_root }}/.beszel_oidc_secrets"
    mode: "0600"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  when:
    - (beszel_client_id | default('') | length == 0)
    - not beszel_oidc_file.stat.exists
    - beszel_oidc_new.changed
  tags: [beszel, config, oidc]

- name: Set Beszel OIDC Facts (Final)
  ansible.builtin.set_fact:
    beszel_final_client_id: >-
      {{ beszel_client_id if (beszel_client_id | default('') | length > 0)
      else (beszel_oidc_content['content'] | b64decode | regex_search('BESZEL_OIDC_CLIENT_ID=([^\n]+)', '\1') | first) if beszel_oidc_file.stat.exists
      else (beszel_oidc_new.stdout | default('') | regex_search('BZ_ID:([a-zA-Z0-9-]+)', '\1') | first) }}
    beszel_final_client_secret: >-
      {{ beszel_client_secret if (beszel_client_secret | default('') | length > 0)
      else (beszel_oidc_content['content'] | b64decode | regex_search('BESZEL_OIDC_CLIENT_SECRET=([^\n]+)', '\1') | first) if beszel_oidc_file.stat.exists
      else (beszel_oidc_new.stdout | default('') | regex_search('BZ_SECRET:([a-zA-Z0-9-]+)', '\1') | first) }}
  tags: [beszel, config, oidc]

# ==============================================================================
# ðŸš€ FINAL DEPLOYMENT
# ==============================================================================

- name: Render docker-compose.yml (Final)
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel_root }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    beszel_dynamic_key: "{{ beszel_final_key }}"
    beszel_dynamic_token: "{{ beszel_final_token }}"
  tags: [beszel, deploy]

- name: Deploy Beszel Stack (Full)
  community.docker.docker_compose_v2:
    project_src: "{{ beszel_root }}"
    state: present
    pull: missing
    remove_orphans: true
    recreate: auto
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, deploy]

# ÐŸÐ°Ñ‚Ñ‡Ð¸Ð½Ð³ OIDC (Ñ‡ÐµÑ€ÐµÐ· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ API)
- name: "âš¡ AUTO-CONFIG: Patch Beszel OIDC Settings"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      # Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð´Ñ€ÐµÑ API
      TOKEN=$(curl -s -X POST "http://127.0.0.1:8090/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel_admin_email }}","password":"{{ beszel_admin_password }}"}' | jq -r '.token')

      if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then echo "FAIL: Login"; exit 1; fi

      curl -X PATCH "http://127.0.0.1:8090/api/collections/users" \
        -H "Authorization: $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
          \"oauth2\": {
            \"enabled\": true,
            \"providers\": [
              {
                \"name\": \"oidc\",
                \"title\": \"PocketID\",
                \"clientId\": \"{{ beszel_final_client_id }}\",
                \"clientSecret\": \"{{ beszel_final_client_secret }}\",
                \"authUrl\": \"https://{{ beszel_identity_domain }}/authorize\",
                \"tokenUrl\": \"https://{{ beszel_identity_domain }}/api/oidc/token\",
                \"userInfoUrl\": \"https://{{ beszel_identity_domain }}/api/oidc/userinfo\",
                \"displayName\": \"PocketID\",
                \"pkce\": true
              }
            ]
          }
        }"
    executable: /bin/bash
  when:
    - beszel_admin_email | length > 0
    - beszel_final_client_id | length > 0
    - beszel_final_client_secret | length > 0
  register: beszel_patch_result
  changed_when: false
  tags: [beszel, config, oidc]
