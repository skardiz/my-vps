---
- name: Validate required Identity secrets (Basic checks)
  ansible.builtin.assert:
    that:
      - vault_identity.lldap.admin_password is defined
      - vault_identity.lldap.key_seed is defined
    fail_msg: "CRITICAL: Missing basic Vault secrets for LLDAP!"
  tags: [deploy, identity, check]

# 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫
- name: Ensure Identity directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ default_puid | default('1000') }}"
    group: "{{ default_pgid | default('1000') }}"
    mode: "0755"
  loop:
    - "{{ identity_compose_dir }}"
    - "{{ identity_data_dir }}/lldap"
    - "{{ identity_data_dir }}/pocketid/data"
    - "{{ identity_data_dir }}/tinyauth"

# ==============================================================================
# ü§ñ SECRET STORAGE (Idempotency)
# ==============================================================================
- name: Check for existing TinyAuth secrets file
  ansible.builtin.stat:
    path: "{{ identity_compose_dir }}/.tinyauth_oidc_secrets"
  register: identity_oidc_file
  tags: [deploy, identity, bootstrap]

- name: Read existing TinyAuth secrets
  ansible.builtin.slurp:
    src: "{{ identity_compose_dir }}/.tinyauth_oidc_secrets"
  register: identity_oidc_content
  when: identity_oidc_file.stat.exists
  tags: [deploy, identity, bootstrap]

# 2. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Compose
- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ identity_compose_dir }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  vars:
    identity_tinyauth_dynamic_id: >-
      {{ (identity_oidc_content['content'] | b64decode | regex_search('CLIENT_ID=([^\n]+)', '\1') | first) if identity_oidc_file.stat.exists else '' }}
    identity_tinyauth_dynamic_secret: >-
      {{ (identity_oidc_content['content'] | b64decode | regex_search('CLIENT_SECRET=([^\n]+)', '\1') | first) if identity_oidc_file.stat.exists else '' }}
  tags: [deploy, identity]

# 3. –ó–∞–ø—É—Å–∫ –°—Ç–µ–∫–∞
- name: Deploy Identity Stack
  community.docker.docker_compose_v2:
    project_src: "{{ identity_compose_dir }}"
    state: present
    pull: always
    remove_orphans: true
    recreate: auto # –ò–∑–º–µ–Ω–∏–ª –Ω–∞ auto
  become: true
  become_user: "{{ deploy_user }}"
  tags: [deploy, identity]

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è LLDAP
- name: Wait for LLDAP container to be healthy
  ansible.builtin.command:
    cmd: docker inspect --format='{{ "{{" }}.State.Health.Status{{ "}}" }}' lldap
  register: identity_lldap_health
  retries: 30
  delay: 5
  until: identity_lldap_health.stdout == 'healthy'
  changed_when: false
  tags: [deploy, identity, bootstrap]

# 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLDAP (Bootstrap Admin)
- name: Bootstrap LLDAP admin attributes
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      docker exec lldap sh -c '
        TOKEN=$(wget -qO- \
          --post-data="{\"username\":\"{{ identity_lldap_admin_dn }}\",\"password\":\"{{ identity_lldap_admin_pass }}\"}" \
          --header="Content-Type: application/json" \
          http://127.0.0.1:{{ identity_lldap_port_http }}/auth/simple/login \
          | grep -o "\"token\":\"[^\"]*" | cut -d"\"" -f4)

        [ -z "$TOKEN" ] && echo "ERROR: Failed to get JWT token" && exit 1

        MUTATION="mutation{updateUser(user:{id:\\\"{{ identity_lldap_admin_dn }}\\\", \
          firstName:\\\"{{ identity_lldap_admin_dn | capitalize }}\\\", \
          email:\\\"{{ identity_lldap_admin_email }}\\\"}){ok}}"

        RESULT=$(wget -qO- \
          --post-data="{\"query\":\"$MUTATION\"}" \
          --header="Content-Type: application/json" \
          --header="Authorization: Bearer $TOKEN" \
          http://127.0.0.1:{{ identity_lldap_port_http }}/api/graphql)

        echo "$RESULT"
        echo "$RESULT" | grep -q "\"ok\":true"
      '
    executable: /bin/bash
  register: identity_lldap_bootstrap
  changed_when: identity_lldap_bootstrap.rc == 0
  failed_when: identity_lldap_bootstrap.rc != 0
  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã —É–∂–µ –µ—Å—Ç—å (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—ã–ª–∞)
  when: not identity_oidc_file.stat.exists
  notify: Restart PocketID for LDAP sync
  tags: [deploy, identity, bootstrap]

- name: Flush handlers to restart PocketID immediately
  ansible.builtin.meta: flush_handlers
  tags: [deploy, identity, bootstrap]

- name: Wait for PocketID LDAP sync to complete
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      docker logs pocketid --tail 100 | grep -q "Job run successfully.*name=SyncLdap"
    executable: /bin/bash
  register: identity_pocketid_sync_check
  retries: 30
  delay: 2
  until: identity_pocketid_sync_check.rc == 0
  changed_when: false
  # –ñ–¥–µ–º —Å–∏–Ω–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –±—É—Ç—Å—Ç—Ä–∞–ø–∏–ª–∏ LLDAP
  when: not identity_oidc_file.stat.exists
  tags: [deploy, identity, bootstrap]

# 6. –ú–∞–≥–∏—è –∞–≤—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OIDC (PocketID -> TinyAuth)
- name: "‚ö° AUTO-SETUP: Setup API Key & OIDC Client via One-Time Token"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      rm -f /tmp/pocket_cookie.txt
      sleep 5

      # 1. –°—Å—ã–ª–∫–∞ –≤—Ö–æ–¥–∞ (CLI)
      LINK_OUTPUT=$(docker exec pocketid /app/pocket-id one-time-access-token {{ identity_lldap_admin_dn }})
      TOKEN=$(echo "$LINK_OUTPUT" | grep -o 'https://[^ ]*' | awk -F/ '{print $NF}' | tr -d '\r')
      if [ -z "$TOKEN" ]; then echo "FAIL: No Token"; exit 1; fi

      # 2. –õ–æ–≥–∏–Ω -> Cookie (Localhost:1411)
      for i in {1..5}; do
        curl -s -c /tmp/pocket_cookie.txt -X POST "http://127.0.0.1:1411/api/one-time-access-token/$TOKEN" > /dev/null
        if grep -q "__Host-access_token" /tmp/pocket_cookie.txt; then break; fi
        sleep 2
      done

      if ! grep -q "__Host-access_token" /tmp/pocket_cookie.txt; then
         echo "WARN: Cookie not found. Login failed?"
         exit 0
      fi

      # 3. API Key (Localhost:1411)
      EXPIRE_DATE="2035-01-01T00:00:00Z"
      API_KEY_RESP=$(curl -s -b /tmp/pocket_cookie.txt \
        -X POST "http://127.0.0.1:1411/api/api-keys" \
        -H "Content-Type: application/json" \
        -d "{\"name\":\"Ansible Auto Key\",\"description\":\"Automated\",\"expiresAt\":\"$EXPIRE_DATE\"}")
      API_TOKEN=$(echo "$API_KEY_RESP" | jq -r '.token // empty')

      # 4. OIDC Client (Localhost:1411)
      OIDC_RESP=$(curl -s -b /tmp/pocket_cookie.txt \
        -X POST "http://127.0.0.1:1411/api/oidc/clients" \
        -H "Content-Type: application/json" \
        -d '{
          "name": "TinyAuth",
          "launchUrl": "https://{{ identity_tinyauth_domain }}",
          "callbackUrls": ["https://{{ identity_tinyauth_domain }}/api/oauth/callback/pocketid"],
          "pkceEnabled": true,
          "isPublic": false
        }')
      CLIENT_ID=$(echo "$OIDC_RESP" | jq -r '.id // empty')

      # –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –µ—Å—Ç—å (–∏–º—è –∑–∞–Ω—è—Ç–æ), API –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ID.
      # –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ `when: not file.exists`, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç.

      if [ -z "$CLIENT_ID" ]; then
         echo "INFO: Failed to create client."
         exit 0
      fi

      # 5. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ï–ö–†–ï–¢–ê
      CLIENT_SECRET=$(echo "$OIDC_RESP" | jq -r '.credentials.secret // .clientSecret // empty')

      if [ -z "$CLIENT_SECRET" ]; then
          SECRET_RESP=$(curl -s -b /tmp/pocket_cookie.txt \
            -X POST "http://127.0.0.1:1411/api/oidc/clients/$CLIENT_ID/secret" \
            -H "Content-Type: application/json")
          CLIENT_SECRET=$(echo "$SECRET_RESP" | jq -r '.secret // empty')
      fi

      if [ -n "$CLIENT_ID" ] && [ -n "$CLIENT_SECRET" ]; then
        echo "ID:$CLIENT_ID"
        echo "SECRET:$CLIENT_SECRET"
        if [ -n "$API_TOKEN" ]; then echo "TOKEN:$API_TOKEN"; fi
      fi
    executable: /bin/bash
  register: identity_auto_oidc_setup
  failed_when: false
  changed_when: "'SECRET:' in identity_auto_oidc_setup.stdout"
  when: not identity_oidc_file.stat.exists
  tags: [deploy, identity, bootstrap, magic]

# 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ–∫—Ä–µ—Ç—ã TinyAuth –≤ —Ñ–∞–π–ª (Idempotency)
- name: Save TinyAuth secrets to file
  ansible.builtin.copy:
    content: |
      CLIENT_ID={{ identity_auto_oidc_setup.stdout | regex_search('ID:([a-zA-Z0-9-]+)', '\1') | first }}
      CLIENT_SECRET={{ identity_auto_oidc_setup.stdout | regex_search('SECRET:([a-zA-Z0-9-]+)', '\1') | first }}
    dest: "{{ identity_compose_dir }}/.tinyauth_oidc_secrets"
    mode: "0600"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  when:
    - not identity_oidc_file.stat.exists
    - identity_auto_oidc_setup.changed
  tags: [deploy, identity, bootstrap, magic]

# 8. –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω—ã)
- name: Set New Secrets Fact
  ansible.builtin.set_fact:
    identity_new_tinyauth_id: "{{ identity_auto_oidc_setup.stdout | regex_search('ID:([a-zA-Z0-9-]+)', '\\1') | first }}"
    identity_new_tinyauth_secret: "{{ identity_auto_oidc_setup.stdout | regex_search('SECRET:([a-zA-Z0-9-]+)', '\\1') | first }}"
  when: identity_auto_oidc_setup.changed
  tags: [deploy, identity, bootstrap, magic] # noqa: no-handler

- name: Re-render docker-compose.yml with new secrets
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ identity_compose_dir }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  vars:
    identity_tinyauth_dynamic_id: "{{ identity_new_tinyauth_id }}"
    identity_tinyauth_dynamic_secret: "{{ identity_new_tinyauth_secret }}"
  when: identity_auto_oidc_setup.changed
  tags: [deploy, identity, bootstrap, magic] # noqa: no-handler

- name: Re-deploy TinyAuth with new credentials
  community.docker.docker_compose_v2:
    project_src: "{{ identity_compose_dir }}"
    services:
      - tinyauth
    state: present
    recreate: always
  become: true
  become_user: "{{ deploy_user }}"
  when: identity_auto_oidc_setup.changed
  tags: [deploy, identity, bootstrap, magic] # noqa: no-handler

# 9. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–≤—Å–µ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ –≤–∏–¥–µ—Ç—å)
- name: Generate One-Time Login Link (Info)
  ansible.builtin.command:
    cmd: docker exec pocketid /app/pocket-id one-time-access-token {{ identity_lldap_admin_dn }}
  register: identity_login_link
  changed_when: false
  tags: [deploy, identity, token]

- name: Display PocketID Login Link
  ansible.builtin.debug:
    msg:
      - "üîê Login to PocketID Admin Console:"
      - "{{ identity_login_link.stdout }}"
      - "This link is valid for one-time use only."
  tags: [deploy, identity, token]
