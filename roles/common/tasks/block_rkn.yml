---
- name: Install ipset and curl
  ansible.builtin.apt:
    name:
      - ipset
      - curl
    state: present

- name: Create directory for RKN scripts
  ansible.builtin.file:
    path: /opt/rkn-block
    state: directory
    mode: '0755'

- name: Deploy RKN update script
  ansible.builtin.copy:
    dest: /opt/rkn-block/update_blacklist.sh
    mode: '0750'
    content: |
      #!/bin/bash
      set -e
      SET_NAME="rugov_blacklist"
      URL="https://raw.githubusercontent.com/C24Be/AS_Network_List/main/blacklists/blacklist.txt"
      TMP_FILE="/tmp/rkn_blacklist.txt"
      if ! curl -s -f "$URL" -o "$TMP_FILE"; then
          echo "Error downloading blacklist"
          exit 1
      fi
      if [ ! -s "$TMP_FILE" ]; then
          echo "Downloaded file is empty!"
          exit 1
      fi
      ipset create "${SET_NAME}_tmp" hash:net -exist
      grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}' "$TMP_FILE" | while read -r line; do
          ipset add "${SET_NAME}_tmp" "$line" -exist
      done
      ipset create "$SET_NAME" hash:net -exist
      ipset swap "${SET_NAME}_tmp" "$SET_NAME"
      ipset destroy "${SET_NAME}_tmp"
      rm "$TMP_FILE"
      iptables -C INPUT -m set --match-set "$SET_NAME" src -j DROP 2>/dev/null || \
      iptables -I INPUT 1 -m set --match-set "$SET_NAME" src -j DROP

- name: Create Systemd service for RKN block
  ansible.builtin.copy:
    dest: /etc/systemd/system/rkn-block.service
    mode: '0644'
    content: |
      [Unit]
      Description=Block RKN subnets via ipset
      After=network.target

      [Service]
      Type=oneshot
      ExecStart=/opt/rkn-block/update_blacklist.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

- name: Enable and Start RKN service
  ansible.builtin.systemd:
    name: rkn-block
    enabled: true
    state: started
    daemon_reload: true

- name: Add cron job for daily updates
  ansible.builtin.cron:
    name: "Update RKN blacklist"
    minute: "0"
    hour: "4"
    job: "systemctl start rkn-block"
