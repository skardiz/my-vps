services:
  {{ oauth2_proxy_service_name }}:
    container_name: {{ oauth2_proxy_service_name }}
    image: {{ oauth2_proxy_image }}
    restart: unless-stopped
    networks:
      - {{ oauth2_proxy_docker_network }}
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_OIDC_ISSUER_URL={{ oauth2_proxy_issuer_url }}
      - OAUTH2_PROXY_CLIENT_ID={{ oauth2_proxy_client_id }}
      - OAUTH2_PROXY_CLIENT_SECRET={{ oauth2_proxy_client_secret }}

      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_COOKIE_SECRET={{ oauth2_proxy_cookie_secret }}
      - OAUTH2_PROXY_COOKIE_DOMAINS={{ oauth2_proxy_cookie_domain }}
      - OAUTH2_PROXY_COOKIE_SECURE=true
      - OAUTH2_PROXY_COOKIE_HTTPONLY=true
      - OAUTH2_PROXY_COOKIE_NAME=__Secure-oauth2_proxy
      - OAUTH2_PROXY_COOKIE_REFRESH=1h

      - OAUTH2_PROXY_REVERSE_PROXY=true
      - OAUTH2_PROXY_WHITELIST_DOMAINS={{ oauth2_proxy_whitelist_domains }}
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_REDIRECT_URL={{ oauth2_proxy_redirect_url }}

      - OAUTH2_PROXY_CODE_CHALLENGE_METHOD=S256

    labels:
      traefik.enable: "true"
      traefik.docker.network: "{{ oauth2_proxy_docker_network }}"

      traefik.http.routers.oauth2-proxy.rule: "Host(`auth.ziix.ru`) && PathPrefix(`/oauth2`)"
      traefik.http.routers.oauth2-proxy.entrypoints: "websecure"
      traefik.http.routers.oauth2-proxy.tls: "true"
      traefik.http.routers.oauth2-proxy.tls.certresolver: "letsencrypt"
      traefik.http.services.oauth2-proxy.loadbalancer.server.port: "4180"

      traefik.http.middlewares.oauth2-proxy-auth.forwardauth.address: "http://oauth2-proxy:4180/oauth2/auth"
      traefik.http.middlewares.oauth2-proxy-auth.forwardauth.trustForwardHeader: "true"
      traefik.http.middlewares.oauth2-proxy-auth.forwardauth.authResponseHeaders: "X-Auth-Request-User,X-Auth-Request-Email"

networks:
  {{ oauth2_proxy_docker_network }}:
    external: true
